<!DOCTYPE html>
<meta charset="utf-8">
<style>

    .axis text {
        font: 10px sans-serif;
    }

    .axis line,
    .axis path {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    div.tooltip {
        /*overflow-y: scroll;*/
        /*position:fixed;*/
        position: absolute;
        /*text-align: center;*/
        left:900px;
        top: 5px;
        width: 298px;
        height: 598px;
        padding: 2px;
        opacity: 0.5;
        font: 16px sans-serif;
        background: white;
        border: 0px;
        border-radius: 8px;
        line-height: 2;
        /*pointer-events: none;*/
    }
    .legend rect {
        fill:white;
        stroke:black;
        opacity:0.8; }
    .legend {
        font-size: 12px;
        background: white;
        /*top: 10px;*/
        /*left:20px;*/
        opacity:1;
    }
</style>
<body>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="../lib/d3.legend.js"></script>
<script src="../lib/jquery.js"></script>

<div id="map" style="width: 880px; height: 600px"></div>
<div class="tooltip"></div>
<div class="legend"></div>
<script>

    var dispatch = d3.dispatch("load", "datechange");
    var parseDate = d3.time.format("%d. %m. %Y").parse;
    var groups = [
        "Odrasli(M)" ,
        "Odrasli(Z)",
        "Osnovnosolci",
        "Predsolski",
        "Srednjesolci",
        "Studentje",
        "Upokojenci(Z)",
        "Upokojenci(M)",
    ];
    var mesec = ["Jan", "Feb", "Apr", "Mar", "Maj", "Jun", "Jul", "Avg", "Sep", "Okt", "Nov", "Dec"];
    var days_of_week = ["Monday", "Tuesday", "Wendsday", "Thursday", "Friday", "Saturday", "Sunday"];
    var museum_coord ={"lat":46.046924, "lng":14.504130};
    var pie_container, tooltip_container, g, select, text_day_of_week;

    function applyLatLngToLayer(d) {
        var y = d.lat;
        var x = d.lng;
        return map.latLngToLayerPoint(new L.LatLng(y, x))
    }

    d3.csv("./calendar/emona_parsed_br.csv", type, function(error, dates_d) {
        if (error) throw error;
        var visitors_by_type = d3.map();
        var datum_now;
        dates_d.forEach(function(d) {
            datum_now = (parseDate(d.datum));
            visitors_by_type.set(parseDate(d.datum), d); });
        dispatch.load(visitors_by_type);
        dispatch.datechange(visitors_by_type.get(datum_now));
// adjust coordinates on zoom change
        map.on("viewreset", update);
        update();
        function update() {
                pie_container.attr("transform", function(d) {
//                   console.log(museum_coord);
                    return "translate("+
                            map.latLngToLayerPoint(museum_coord).x +","+
                            map.latLngToLayerPoint(museum_coord).y +")";
                });
        }
    });

    // A drop-down menu for selecting a dates;
    dispatch.on("load.menu", function(visitors_by_type) {
         select = d3.select(".tooltip")
                .append("div")
                .append("select")
                .on("change", function() {
//                    console.log();
                    dispatch.datechange(visitors_by_type.get(parseDate(this.value))) });

        select.selectAll("option")
                .data(visitors_by_type.values())
                .enter().append("option")
                .attr("value", function(d) { return d.datum; })
                .text(function(d) {
                    var date = parseDate(d.datum);
                    var dateString =  date.getDate()+1 + "-" +
                            mesec[date.getUTCMonth()] +" " + date.getFullYear();
                    return dateString;
                });

        dispatch.on("datechange.menu", function(date) {

            select.property("value", date.datum);

            text_day_of_week.text(days_of_week[(parseDate(date.datum)).getDay()]);
        });


    });

    // A bar chart to show total visitors; .
    dispatch.on("load.bar", function(visitors_by_type) {
        var margin = {top: 20, right: 20, bottom: 30, left: 40},
                width = 900  - margin.left - margin.right,
                height = 460 - margin.top - margin.bottom;
// y-axis scale
        var y = d3.scale.linear()
                .domain([0, d3.max(visitors_by_type.values(), function(d) { return d.total; })])
                .rangeRound([height+20, 20])
                .nice();

//y-axis
        var yAxis = d3.svg.axis()
                .scale(y)
                .orient("left")
                .tickFormat(d3.format(".2s"));
//
         tooltip_container = d3.select(".tooltip").append("svg:svg")
                .attr("width",width-4)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
//append day of week
        text_day_of_week = tooltip_container.append("text").text(days_of_week[(parseDate(select.node().value)).getDay()]);
        tooltip_container.append("g")
                .attr("class", "y axis")
                .call(yAxis);

// visitors bar
        var rect = tooltip_container.append("svg:rect")
                .attr("x", 10)
                .attr("width", 50)
                .attr("y", height)
                .attr("height", 0)
                .attr("class", "rectan")
                .style("fill", "#aaa");
//visitors bar change on date change
        dispatch.on("datechange.bar", function(d) {
//            console.log((d.total));
            rect.transition()
                    .attr("y", y(d.total))
                    .attr("height", y(0) - y(d.total));
        });
    });


    // A pie chart to show vistors  by "age" group;
    dispatch.on("load.pie", function(visitors_by_type) {
        var width = 880,
                height = 460,
                radius = Math.min(width, height) / 6;

        var color = d3.scale.ordinal()
                .domain(groups)
        .range(["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf",""]);


        var arc = d3.svg.arc()
                .outerRadius(radius - 10)
//                .innerRadius(radius - 70);

        var pie = d3.layout.pie()
                .sort(null);


         pie_container = g.append("svg:svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", function(d) {
//                   console.log(museum_coord);
                    return "translate("+
                            map.latLngToLayerPoint(museum_coord).x +","+
                            map.latLngToLayerPoint(museum_coord).y +")";
                });

        var path = pie_container.selectAll("path")
                .data(groups)
                .enter().append("path")
                .style("fill", color)
                .attr("data-legend", function(d){
                    return d})
                .style("fill", function (d) { return color(d); })
                .each(function() { this._current = {startAngle: 0, endAngle: 0}; })

// add legend
        var legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", function(d) {
//                   console.log(museum_coord);
                    return "translate(50,50)"
                })
                .style("font-size", "16px")
                .call(d3.legend);


        dispatch.on("datechange.pie", function(d) {
            path.data(pie.value(function(g) {
//                console.log(g)
                return d[g]; })(groups)).transition()
                    .attrTween("d", function(d) {
                        var interpolate = d3.interpolate(this._current, d);
                        this._current = interpolate(0);
                        return function(t) {
//                            console.log(arc(interpolate(t)))
                            return arc(interpolate(t));
                        };
                    });
        });
    });

    // Coerce visitors counts to numbers and compute total per date.
    function type(d) {
        d.total = d3.sum(groups, function(k) { return d[k] = +d[k]; });
        return d;
    }
    // init_map
    map = L.map('map').setView([46.046924, 14.504130], 17);
    mapLink =
            '<a href="http://openstreetmap.org">OpenStreetMap</a>';


    L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; ' + mapLink + ' Contributors',
                maxZoom: 17,
                minZoom: 8
            }).addTo(map);
    // Initialize the SVG layer
    map._initPathRoot();
    // pick up the SVG from the map object
    var svg = d3.select("#map").select("svg");
            g = svg.append("g").attr("class", "leaflet-zoom-hide");

</script>

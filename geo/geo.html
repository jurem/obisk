<!DOCTYPE html>
<html>
<head>
    <title>GEO vizualizacija</title>
    <link
            rel="stylesheet"
            href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css"
            />
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
    <!-- Latest compiled and minified CSS -->

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!--<script src="bootstrap-3.3.5/js/bootstrap.min.js"></script>-->
</head>
<style>
    div.tooltip {
        position: absolute;
        /*text-align: center;*/
        left:620px;
        top: 5px;
        width: 298px;
        height: 598px;
        padding: 2px;
        opacity: 0.5;
        font: 16px sans-serif;
        background: white;
        border: 0px;
        border-radius: 8px;
        line-height: 2;
        /*pointer-events: none;*/
    }

</style>
<body>
<div id="map" style="width: 600px; height: 600px"></div>

<div class = "tooltip"><input class="filter_button"  type="checkbox" >Obiskanost</input><br></div>
<script type="text/javascript">
var width = 600,
        height = 600;
//    var map = L.map('map').setView([-41.2858, 174.7868], 13);
var parseDate = d3.time.format("%d-%m-%y").parse;
var vhodi = {"A": 0, "B":0, "C":0, "D": 0, "E":0, "sum":0};
var mesec = ["Jan", "Feb", "Apr", "Mar", "Maj", "Jun", "Jul", "Avg", "Sep", "Okt", "Nov", "Dec"];
var days_of_week = ["Monday", "Tuesday", "Wendsday", "Thursday", "Friday", "Saturday", "Sunday"];
var dataDict = [];
var vhodiScale = 120;
var visibility = "hidden";
var vis = 0;
var hala_a_coord = {"lat":46.066572, "lng":14.542744};
function show_text(d){d.transition().duration(200)
        .style("opacity", vis);}
var text, text_all, avg, monthly_avg, feature, text_tooltip_date,feature_one_by_one, feature_all,select,
        current_date //current date
        ;
function calculate_circle_r(a, b, c){
    current_date = a;
    return a[b]/a.sum*vhodiScale*c;
}
function applyLatLngToLayer(d) {
//    console.log(d);
    var y = d.lat;
    var x = d.lng;
    return map.latLngToLayerPoint(new L.LatLng(y, x))
}
d3.json("./res/dataSept.json", function(error, dataCal) {
    var sum = 0;
    dataCal.forEach(function(d) {
        sum+=1;
        d.datum = parseDate(d.datum);
        vhodi.A += d.A;
        vhodi.B += d.B;
        vhodi.C += d.C;
        vhodi.D += d.D;
        vhodi.E += d.E;
        vhodi.sum += (d.A+ d.B+ d.C+ d.D+ d.E);
        dataDict[Date.parse(d.datum)] =  {"A": d.A, "B": d.B, "C": d.C, "D": d.D, "E":d.E, "sum":(d.A+ d.B+ d.C+ d.D+ d.E)};

    } );
    monthly_avg = vhodi.sum / sum ;

//select DATE
     select = d3.select(".tooltip")
            .append("div")
            .append("select");

// add dates to combo_box
    select.selectAll("option")
                .data(dataCal)
                .enter()
                .append("option")
                .attr("value", function (d) { return d.datum; })
                .text(function (d) {
                    var dateString =  d.datum.getDate()+1 + "-" +
                            mesec[d.datum.getUTCMonth()] +" " + d.datum.getFullYear();
                    return dateString; });

// actoion on change combo_box
    select.on("change", function(d) {
        var date = new Date(d3.select(this).property("value"));
                var value =  Date.parse(d3.select(this).property("value"));
        var day_string = days_of_week[date.getDay()];
        avg = dataDict[value]["sum"] / 5;
        feature_one_by_one.transition()
                .duration(200)
                .style("fill", function(d){
//                    console.log(dataDict[value][d.circle.name] + " " + avg);
                if(avg > dataDict[value][d.circle.name]){
                    return "red";
                }else{
                    return "green";
                }})
                .attr("r", function(d){
//                    console.log( dataDict[value][d.circle.name]);
                    var temp_r = calculate_circle_r(dataDict[value], d.circle.name,1);
                    return temp_r < 20? 20: temp_r});
//
        text.transition().duration(200)
                .text(function(d) {
//                    console.log(current_date[d.circle.name]);
                    return current_date[d.circle.name]; });
        feature_all.transition()
                .duration(200)
                .attr("r", function(d){
                    return dataDict[value].sum /vhodiScale})
                .style("fill", function(d){
                    if(monthly_avg > dataDict[value]["sum"]){
                        return "red";
                    }else{
                        return "green";
                    }
                });
        text_all.transition()
                .duration(200)
                .text( function(d){
                    return dataDict[value].sum });
        //change date on .tooltip
        text_tooltip_date.text(day_string);
        });

    //end select DATE
            });

//filterButton (Checkbox)

d3.selectAll(".filter_button").on("change", function() {
    var type = this.value;
//    console.log(type);
    vis = vis==0?1:0;
    display = vis == 1 ? "visible" : "hidden";
    if(map.getZoom() >15) {
        text.transition().duration(200)
                .style("opacity", vis);
//        console.log(calculate_circle_r(current_date, d.circle.name,1 + 2*vis));
    }else{
        text_all.transition().duration(200)
                .style("opacity", vis);
    }

});
//end filterButton

    d3.json("res\\circle.json", function(collection) {
// Add a LatLng object to each item in the dataset

        if(collection == null){
            collection = {"objects":[
                {"circle":{"name":"A", "coordinates":[46.067292, 14.541943]}},
                {"circle":{"name":"B","coordinates":[46.066647, 14.542317]}},
                {"circle":{"name":"C","coordinates":[46.065330, 14.543121]}},
                {"circle":{"name":"D","coordinates":[46.067090, 14.542861]}},
                {"circle":{"name":"E","coordinates":[46.065539, 14.543729]}}
            ]};
        }

        collection.objects.forEach(function(d) {
            d.LatLng = new L.LatLng(d.circle.coordinates[0],
                    d.circle.coordinates[1]);
        });
        current_date = dataDict[Date.parse(select.node().value)];
        avg = current_date["sum"] / 5;

//        console.log("CurrentDate " + current_date);

//console.log(collection.objects);

//circle
        feature = g.selectAll("circle")
                .data(collection.objects)
                .enter()
                .append("circle");

        feature_one_by_one = feature
                .style("stroke", "black")
                .style("fill", function(d){
                    if(avg >dataDict[Date.parse(select.node().value)][d.circle.name] ){
                        return "red"
                    }else{
                        return "green"
                    }
                    return "red";})
                .attr("r", function(d){
//                    console.log(dataDict[Date.parse(select.node().value)][d.circle.name]);
                    return calculate_circle_r(dataDict[Date.parse(select.node().value)], d.circle.name,1);
                }) .on("mouseover", function(d){
                    if(vis == 0){
                    d3.select(this).transition()
                            .ease('circle-out')
                            .duration('200').attr('r', calculate_circle_r(current_date, d.circle.name,2))
                            .style('cursor','pointer');
                    d3.select("#obiski_" + d.circle.name).transition().style("opacity", 1);
                    }

                          }) .on("mouseout", function(d) {
                    if(vis == 0){
                    d3.select(this).transition()
                            .ease('circle-in')
                            .duration(500)
                            .attr('r', calculate_circle_r(current_date, d.circle.name,1));
                    d3.select("#obiski_" + d.circle.name).transition().duration(250).style("opacity", 0);}
                });
//        krogci(feature_one_by_one);
        feature_all = g.append("circle")
                .style("stroke", "black")
                .style("opacity", 0)
                .style("fill", "red")
                .attr('class', "feature_all")
                .attr("transform", function(d) {
//                   console.log(collection.objects);
                    return "translate("+
                            map.latLngToLayerPoint(hala_a_coord).x +","+
                            map.latLngToLayerPoint(hala_a_coord).y +")";
                })
                .attr("r", function(){
                    return current_date["sum"]/vhodiScale == 0? 1:current_date["sum"]/vhodiScale})
                .on("mouseover", function(d){
                    if(map.getZoom() <=15 && vis == 0){
                        text_all.transition().style("opacity", 1);}})
                .on("mouseout", function(d) {
                    if(vis == 0){
                        text_all.transition().duration(250).style("opacity", 0);}
                });
//end circle
//text
        text = g.selectAll("text")
                .data(collection.objects)
                .enter()
                .append("text")
                .attr("class", ".obiski")
                .attr("id", function(d){return "obiski_"+ d.circle.name})
                .attr("x", function(d) {
                    return applyLatLngToLayer(d.LatLng).x +1
                })
                .attr("y", function(d) {
                    return applyLatLngToLayer(d.LatLng).y+1
                })
                .style("visibility", "visible" )
                .attr("text-anchor", "middle")
                .style("opacity", "0")
                .style("font-size", "16px")
                .style("pointer-events", "none")
                .attr('font', 'Arial')
                .attr("fill","white")
                .text(function(d) {
//                    console.log(current_date[d.circle.name]);
                    return current_date[d.circle.name]; });
        text_all = g
                .append("text")
                .attr("class", ".obiski_all")
                .attr("transform", function(d) {
                    return "translate("+
                            map.latLngToLayerPoint(hala_a_coord).x +","+
                            map.latLngToLayerPoint(hala_a_coord).y +")";
                })
                .style("visibility", "visible" )
                .attr("text-anchor", "middle")
                .style("opacity", 1)
                .style("pointer-events", "none")
                .style("font-size", "16px")
                .attr('font', 'Arial')
                .attr("fill","white")
                .text(function(d) {
//                    console.log(current_date["sum"]);
                    return current_date["sum"]; });
        //end text
//tooltip
        text_tooltip_date = d3.select(".tooltip").append("text").text(function(){
            var d = new Date(select.node().value);
            return days_of_week[d.getDay()];
        });
        //end tooltip

//        var text = feature.append("text");
        map.on("viewreset", update);
        update();
        function update() {
//            console.log(map.getZoom());
            if(map.getZoom() >15){
                //circles_one_by_one show
                feature_one_by_one.attr("transform",
                    function(d) {
                        return "translate("+
                                map.latLngToLayerPoint(d.LatLng).x +","+
                                map.latLngToLayerPoint(d.LatLng).y +")";
                    }
                ).style("opacity", 0.6).style("pointer-events", "inherit");
//text one_by_one show
            text.attr("x", function(d) {return applyLatLngToLayer(d.LatLng).x})
                    .attr("y", function(d) {return applyLatLngToLayer(d.LatLng).y})
                    .style("opacity", vis);

                feature_all.transition().style("opacity", 0).style("pointer-events", "none");
          text_all.transition().style("opacity", 0);
        }else{
                //circle all show
           feature_all.attr("transform", function(d) {
                    return "translate("+
                            map.latLngToLayerPoint(hala_a_coord).x +","+
                            map.latLngToLayerPoint(hala_a_coord).y +")";
                })
                   .style("opacity", 0.6).style("pointer-events", "inherit");
                //text all show
                text_all.attr("transform", function(d) {
                    return "translate("+
                            map.latLngToLayerPoint(hala_a_coord).x +","+
                            map.latLngToLayerPoint(hala_a_coord).y +")";
                }).transition().style("opacity", vis);
//circle one by one hide
                feature_one_by_one.attr("transform", function(d) {
               return "translate("+
                       map.latLngToLayerPoint(hala_a_coord).x +","+
                       map.latLngToLayerPoint(hala_a_coord).y +")";
           }).style("opacity", 0).style("pointer-events", "none");
  //text one_by_one hide
                text.style("opacity", 0);
            }

        }
    });


// init_map
    map = L.map('map').setView([46.066776, 14.542722], 17);
    mapLink =
            '<a href="http://openstreetmap.org">OpenStreetMap</a>';
    L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; ' + mapLink + ' Contributors',
                maxZoom: 18,
                minZoom: 7
            }).addTo(map);
    // Initialize the SVG layer
    map._initPathRoot();
// We pick up the SVG from the map object
var svg = d3.select("#map").select("svg"),
        g = svg.append("g").attr("class", "leaflet-zoom-hide");



</script>
</body>
</html>